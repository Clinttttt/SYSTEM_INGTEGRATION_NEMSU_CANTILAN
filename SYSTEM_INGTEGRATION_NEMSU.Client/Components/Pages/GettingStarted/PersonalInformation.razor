@inject PageState pageState
@inject IStudentRecordApiCommand studentRecordApi
@rendermode InteractiveServer

<div class="space-y-4 ">
    <div class="text-center mb-6">
        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>
        <h2 class="text-xl font-bold text-slate-600 mb-1">Personal Information</h2>
        <p class="text-sm text-slate-500">Provide your personal details for student records</p>
    </div>

    <EditForm Model="@PersonalDetails" OnValidSubmit="@HandlePersonalInformation" FormName="PersonalInformation">
        <DataAnnotationsValidator />
        <div class="space-y-4">


            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">First Name</label>
                    <InputText @bind-Value="PersonalDetails.FirstName" placeholder="Enter first name"
                               class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400" />
                    <ValidationMessage For="@(() => PersonalDetails.FirstName)" class="text-red-600 text-xs mt-1" />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Middle Name</label>
                    <InputText @bind-Value="PersonalDetails.MiddleName" placeholder="Enter middle name"
                               class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400" />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Last Name</label>
                    <InputText @bind-Value="PersonalDetails.LastName" placeholder="Enter last name"
                               class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400" />
                    <ValidationMessage For="@(() => PersonalDetails.LastName)" class="text-red-600 text-xs mt-1" />
                </div>
            </div>


            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Date of Birth</label>
                    <InputDate @bind-Value="PersonalDetails.DateOfBirth"
                               class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-600
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400" />
                 
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Gender</label>
                    <InputSelect @bind-Value="PersonalDetails.Gender"
                                 class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-600
                                   focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                   hover:border-slate-400">
                        <option value="">Select Gender</option>
                        <option value="@GenderChoice.Male">Male</option>
                        <option value="@GenderChoice.Female">Female</option>
                        <option value="@GenderChoice.Prefer_not_to_say">Prefer not to say</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => PersonalDetails.Gender)" class="text-red-600 text-xs mt-1" />
                </div>
            </div>


            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Civil Status</label>
                    <InputSelect @bind-Value="PersonalDetails.CivilStatus"
                                 class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm text-slate-600
                                   focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                   hover:border-slate-400">
                        <option value="">Select Status</option>
                        <option value="@CivilStatusChoice.Single">Single</option>
                        <option value="@CivilStatusChoice.Taken">Taken</option>
                        <option value="@CivilStatusChoice.Married">Married</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => PersonalDetails.CivilStatus)" class="text-red-600 text-xs mt-1" />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Nationality</label>
                    <InputText @bind-Value="PersonalDetails.Nationality" placeholder="e.g., Filipino"
                               class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400" />
                    <ValidationMessage For="@(() => PersonalDetails.Nationality)" class="text-red-600 text-xs mt-1" />
                </div>
            </div>


            <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Permanent Address</label>
                <InputText @bind-Value="PersonalDetails.PermanentAddress" placeholder="Enter permanent address"
                           class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                              hover:border-slate-400" />
                <ValidationMessage For="@(() => PersonalDetails.PermanentAddress)" class="text-red-600 text-xs mt-1" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Guardian/Parent Name</label>
                <InputText @bind-Value="PersonalDetails.GuardianName" placeholder="Enter guardian/parent name"
                           class="w-full px-3 py-2.5 border border-slate-300 rounded-lg text-sm
                              focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                              hover:border-slate-400" />
                <ValidationMessage For="@(() => PersonalDetails.GuardianName)" class="text-red-600 text-xs mt-1" />
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Guardian/Parent Contact</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-cyan-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M7.25 11.5C6.83579 11.5 6.5 11.8358 6.5 12.25C6.5 12.6642 6.83579 13 7.25 13H8.75C9.16421 13 9.5 12.6642 9.5 12.25C9.5 11.8358 9.16421 11.5 8.75 11.5H7.25Z" />
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M6 1C4.61929 1 3.5 2.11929 3.5 3.5V12.5C3.5 13.8807 4.61929 15 6 15H10C11.3807 15 12.5 13.8807 12.5 12.5V3.5C12.5 2.11929 11.3807 1 10 1H6ZM10 2.5H9.5V3C9.5 3.27614 9.27614 3.5 9 3.5H7C6.72386 3.5 6.5 3.27614 6.5 3V2.5H6C5.44771 2.5 5 2.94772 5 3.5V12.5C5 13.0523 5.44772 13.5 6 13.5H10C10.5523 13.5 11 13.0523 11 12.5V3.5C11 2.94772 10.5523 2.5 10 2.5Z" />
                        </svg>
                    </span>
                    <InputText @bind-Value="PersonalDetails.GuardianContact"
                               class="w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg text-sm
                                  focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all
                                  hover:border-slate-400"
                               placeholder="09XX XXX XXXX" />
                </div>
                <ValidationMessage For="@(() => PersonalDetails.GuardianContact)" class="text-red-600 text-xs mt-1" />
            </div>


            @if (!string.IsNullOrEmpty(Error))
            {
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    @Error
                </div>
            }

            <div  class="flex justify-between gap-3 pt-4 border-t border-slate-200">
                <button type="button" @onclick="()=> SaveAsDraft()"
                        class="flex-1 px-4 flex py-2.5 text-sm gap-2 border border-slate-300 text-slate-700 rounded-lg font-medium
                               hover:bg-slate-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Save as Draft
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-2.5 text-sm  bg-gradient-to-br from-cyan-600 to-teal-600 text-white rounded-lg font-medium
                               hover:from-cyan-700 flex gap-2 hover:to-teal-800 transition-all shadow-md items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Save
                </button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    public PersonalInformationDto PersonalDetails { get; set; } = new();
    public string? Error { get; set; }

    public async Task HandlePersonalInformation()
    {
        Error = null;
        PersonalDetails.Savestatus = SaveStatus.Save;
        var response = await studentRecordApi.AddPersonalDetailsAsync(PersonalDetails);
        if (response is null)
        {
            Error = "Unable to save. The student record may already exist or there was an error.";
            return;
        }

        pageState.SetViewPerInfo(PageState.SaveAsDraftPerInfo.Save);
    }

    public async Task SaveAsDraft()
    {
        Error = null;
        PersonalDetails.Savestatus = SaveStatus.Save_As_Draft;
        var response = await studentRecordApi.AddPersonalDetailsAsync(PersonalDetails);
        if (response is null)
        {
            Error = "Unable to save draft. Please try again.";
            return;
        }

        pageState.SetViewPerInfo(PageState.SaveAsDraftPerInfo.SaveASDraft);
    }
}