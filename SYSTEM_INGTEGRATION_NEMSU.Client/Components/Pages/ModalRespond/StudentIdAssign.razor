@inject IStudentRecordApiCommand studentRecordApi
@inject IJSRuntime JS
@inject IEnrollmentApiServices enrollmentApi

<input type="checkbox" id="my_modal_studentId_Assign" class="modal-toggle" />
<div class="modal" role="dialog">
    <div class="modal-box max-w-lg rounded-xl shadow-2xl p-0">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-teal-500 to-cyan-600 p-6 rounded-t-xl">
            <h3 class="text-2xl font-bold text-white mb-2">Student ID Setup</h3>
            <p class="text-teal-50 text-sm">
                @if (needNewId)
                {
                    <span>We'll generate a new Student ID for you</span>
                }
                else
                {
                    <span>Please provide your existing Student ID to continue</span>
                }
            </p>
        </div>

        <!-- Content Section -->
        <div class="p-6 space-y-6">
            <!-- Photo Upload Section -->
            <div class="flex flex-col items-center">
                <label class="relative group cursor-pointer">
                    <div class="w-32 h-32 rounded-2xl overflow-hidden border-4 border-gray-200 group-hover:border-teal-500 transition-all duration-300 shadow-lg">
                        @if (PreviewUrl != null)
                        {
                            <img src="@PreviewUrl" alt="Student Photo" class="w-full h-full object-cover" />
                            <div class="absolute inset-0 bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center">
                                <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        }
                        else
                        {
                            <div class="w-full h-full bg-gradient-to-br from-teal-100 to-cyan-100 flex flex-col items-center justify-center">
                                <svg class="w-12 h-12 text-teal-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span class="text-xs text-teal-700 font-medium">Upload Photo</span>
                            </div>
                        }
                    </div>
                    <InputFile OnChange="HandleFileSelected" type="file" accept="image/*" class="hidden" />
                </label>
                <p class="text-xs text-gray-500 mt-3 text-center">Click to upload your photo<br />(Max 10MB)</p>
            </div>

            
            <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                    </svg>
                    Student ID
                    <span class="text-red-500">*</span>
                </label>
                <input type="text"
                @bind="StudentId.StudentSchoolId"
                placeholder="@(needNewId ? "Will be auto-generated" : "Enter your Student ID (e.g., 2024-1234)")"
                class="input input-bordered w-full h-12 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all"
                disabled="@needNewId"
                required />
            </div>


            @if (showGeneratedId && !string.IsNullOrEmpty(generatedId))
            {
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 animate-pulse">
                    <div class="flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-green-800 mb-1">Your new Student ID has been generated!</p>
                            <p class="text-3xl font-bold text-green-900 tracking-wide">@generatedId</p>
                        </div>
                    </div>
                </div>
            }

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMsg))
            {
                <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-sm text-red-800 font-medium">@errorMsg</span>
                    </div>
                </div>
            }
        </div>


        <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex flex-col-reverse sm:flex-row gap-3 sm:justify-end border-t border-gray-200">
            @if (!needNewId)
            {
                <button @onclick="SwitchToNewId"
                class="btn btn-ghost text-gray-600 hover:bg-gray-200 border border-gray-300 normal-case h-11">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    I don't have a Student ID
                </button>
            }

            <button @onclick="ProceedEnrollment"
            class="btn bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700 text-white border-none normal-case h-11 shadow-lg hover:shadow-xl transition-all"
            disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="loading loading-spinner loading-sm"></span>
                    <span>Processing...</span>
                }
                else
                {
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                    <span>Proceed to Enrollment</span>
                }
            </button>
        </div>
    </div>
</div>

@code {
    private bool needNewId = false;
    private bool isLoading = false;
    private string? errorMsg = null;
    private bool showGeneratedId = false;
    private string? generatedId = null;

    public string? PreviewUrl { get; set; }
    public byte[]? Photo { get; set; }
    public string? PhotoContentType { get; set; }

    public StudentMiniInfoDto info { get; set; } =  new StudentMiniInfoDto();
    public SchoolIdDto StudentId { get; set; } = new SchoolIdDto();
    [Parameter]
    public EventCallback reload { get; set; }

    private void SwitchToNewId()
    {
        needNewId = true;
        StudentId.StudentSchoolId = "";
        showGeneratedId = false;
        generatedId = null;
        errorMsg = null;
    }

    private void SwitchToExisting()
    {
        needNewId = false;
        StudentId.StudentSchoolId = "";
        showGeneratedId = false;
        generatedId = null;
        errorMsg = null;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var buffer = ms.ToArray();
        Photo = buffer;
        PhotoContentType = file.ContentType;

        PreviewUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        info.Photo = Photo;
        info.PhotoContentType = PhotoContentType;
        StateHasChanged();
    }

    public async Task ProceedEnrollment()
    {
        try
        {
            isLoading = true;
            errorMsg = null;

            if (needNewId)
            {
                StudentId = await enrollmentApi.GenerateStudentId();
                generatedId = StudentId?.StudentSchoolId;
                showGeneratedId = true;
                await Task.Delay(2000);
            }
            else
            {
                if (string.IsNullOrWhiteSpace(StudentId.StudentSchoolId))
                {
                    errorMsg = "Please enter your Student ID";
                    return;
                }
            }
            info.StudentSchoolId = StudentId!.StudentSchoolId;
            await studentRecordApi.StudentSchoolIdAsync(info);
            await JS.InvokeVoidAsync("eval",
                "document.getElementById('my_modal_studentId_Assign').checked = false");
            await reload.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error: {ex.Message}";
            showGeneratedId = false;
        }
        finally
        {
            isLoading = false;
        }
    }
}